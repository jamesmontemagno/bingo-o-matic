@page "/custom-bingo"
@using Microsoft.AspNetCore.Components
@using System.Web
@using Microsoft.AspNetCore.Components.Web
@using BingoApp.Models
@using BingoApp.Services
@using BingoApp.Helpers
@using BingoApp.Components
@implements IAsyncDisposable

@inject BingoSetService BingoService
@inject NavigationManager NavigationManager
@inject ILocalBrowserStorageService LocalStorageService
@inject IGameStateService GameStateService
@inject IJSRuntime JSRuntime

<div class="bingo-container">
    <div class="bingo-header">
        <div class="bingo-controls">
            <div class="draw-toggle-row d-flex flex-column flex-md-row align-items-center gap-3 mt-2">
                <button class="btn btn-primary btn-lg flex-shrink-0" @onclick="SelectNext" disabled="@(selectedSet == null || isSelecting)">
                    <i class="bi bi-shuffle"></i> Draw Item
                </button>
                @if (calledItems.Count > 0)
                {
                    <button class="btn btn-success btn-lg flex-shrink-0 bingo-button" 
                            @onclick="CelebrateBingo"
                            disabled="@(isSelecting || showConfetti)">
                        <i class="bi bi-trophy"></i> Bingo!
                    </button>
                }
                @if (!isMobileDevice)
                {
                    <div class="mode-toggle @((selectedSet == null || isSelecting) ? "disabled" : "")" role="group" aria-label="Selection mode">
                        <button type="button" 
                                class="mode-toggle-btn @(selectionMode == SelectionMode.Cards ? "active" : "")" 
                                @onclick="() => SetMode(SelectionMode.Cards)"
                                disabled="@isSelecting"
                                aria-pressed="@(selectionMode == SelectionMode.Cards)">
                            <i class="bi bi-list-ul"></i>
                            <span>Cards</span>
                        </button>
                        <button type="button" 
                                class="mode-toggle-btn @(selectionMode == SelectionMode.Wheel ? "active" : "")" 
                                @onclick="() => SetMode(SelectionMode.Wheel)"
                                disabled="@isSelecting"
                                aria-pressed="@(selectionMode == SelectionMode.Wheel)">
                            <i class="bi bi-palette"></i>
                            <span>Wheel</span>
                        </button>
                        <button type="button" 
                                class="mode-toggle-btn @(selectionMode == SelectionMode.Grid ? "active" : "")" 
                                @onclick="() => SetMode(SelectionMode.Grid)"
                                disabled="@isSelecting"
                                aria-pressed="@(selectionMode == SelectionMode.Grid)">
                            <i class="bi bi-grid-3x3-gap"></i>
                            <span>Grid</span>
                        </button>
                    </div>
                }

                @if ((selectedSet == null || calledItems.Count == 0) && !isSelecting)
                {
                    <div class="selector-row flex-grow-1">
                        <div class="form-group">
                            <select class="form-select" id="bingoSet" @bind="pendingSetName" @bind:after="OnBingoSetSelectionChanged"  disabled="@(isSelecting)">
                                <option value="">Select a set...</option>
                                @foreach (var set in bingoSets)
                                {
                                    <option value="@set.Name">@set.Name</option>
                                }
                            </select>
                        </div>
                        <a href="/custom-bingo/manage" class="btn btn-outline-secondary manage-btn" title="Manage Bingo Sets" aria-label="Manage Bingo Sets">
                            <i class="bi bi-gear"></i>
                            <span class="visually-hidden">Manage</span>
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>

    @if (selectedSet != null)
    {
        <div class="game-content">
            @if (isSelecting)
            {                
                @if (selectionMode == SelectionMode.Wheel)
                {
                    <BingoWheel @ref="wheelRef"
                               Items="@availableItems"
                               IsVisible="@wheelVisible"
                               OnSelectionComplete="OnWheelSelectionComplete" />
                }
                else if (selectionMode == SelectionMode.Grid)
                {
                    <GridSelector 
                        IsSelecting="true"
                        Items="@availableItems"
                        ThemeColor="@currentThemeColor"
                        @ref="gridSelector"
                        OnItemSelected="OnGridItemSelected" />
                }
                else
                {
                    <div class="current-item selecting @(isAnimating ? "animate" : "")" aria-live="polite">
                        <div class="item-display @(isSelected ? "selected" : "idle")" style="background-color: @currentThemeColor">
                            <span class="item">@(displayItem ?? "Ready to draw...")</span>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="current-item @(isSelecting ? "selecting" : "") @(isAnimating ? "animate" : "")" aria-live="polite">
                    <div class="item-display @(isSelected ? "selected" : "idle")" style="background-color: @currentThemeColor">
                        <span class="item">@(displayItem ?? "Ready to draw...")</span>
                    </div>
                </div>
            }

            <div class="called-items">
                <h4>Called Items</h4>
                <div class="called-items-grid">
                    @if (calledItems.Count > 0)
                    {
                        @foreach (var item in calledItems.AsEnumerable().Reverse())
                        {
                            bool isLatestItem = calledItems.IndexOf(item) == calledItems.Count - 1;
                            <div class="item-cell called @(isLatestItem ? "latest" : "previous")" style="@(isLatestItem ? $"background-color: {currentThemeColor}" : $"border-color: {currentThemeColor}")">
                                <span>@item</span>
                            </div>
                        }
                    }
                    else
                    {
                        <p>No items selected yet. Click "Draw Item" to begin.</p>
                    }
                </div>
            </div>
            <div class="reset-btn-row mt-3 d-flex justify-content-center">
                <button class="btn btn-outline-primary" @onclick="ConfirmNewGame" disabled="@(selectedSet == null || isSelecting)">
                    <i class="bi bi-arrow-repeat"></i> Reset Game
                </button>
            </div>
            
        </div>
    }
</div>

@* Confirmation Dialog *@
@if (showConfirmDialog)
{
    <div class="modal-backdrop show"></div>
    <div class="modal fade show" tabindex="-1" role="dialog" style="display: block;">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@confirmTitle</h5>
                    <button type="button" class="btn-close" @onclick="CancelConfirmation"></button>
                </div>
                <div class="modal-body">
                    <p>@confirmMessage</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelConfirmation">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmAction">Confirm</button>
                </div>
            </div>
        </div>
    </div>
}

<Confetti Show="@showConfetti" />

<ResumeGameDialog 
    Show="@showResumeDialog" 
    GameType="Custom Bingo" 
    GameDetails="@resumeGameDetails"
    OnResult="OnResumeDialogResult" />

@code {
    private enum SelectionMode
    {
        Cards,
        Wheel,
        Grid
    }

    private SelectionMode selectionMode = SelectionMode.Cards;
    private GridSelector? gridSelector;

    private string selectedSetName = "";
    private string pendingSetName = "";
    private List<BingoSet> bingoSets = new();
    private BingoSet? selectedSet;
    private bool isSelecting = false;
    private bool isSelected = false;
      // Bingo board state
    private List<string> availableItems = new List<string>();
    private List<string> calledItems = new List<string>();
    private Random random = new Random();
    private string? currentItem;
    private string? displayItem;
    private bool isAnimating = false;
    private CancellationTokenSource? animationCts;
    private string currentThemeColor = "";

    // Confirmation dialog state
    private bool showConfirmDialog = false;
    private string confirmTitle = "";
    private string confirmMessage = "";    private Func<Task>? confirmAction;    // Wheel state
    private Components.BingoWheel? wheelRef;
    private bool wheelVisible = false;
    private bool isMobileDevice;
    private IJSObjectReference? module;// Confetti state
    private bool showConfetti;
    private CancellationTokenSource? confettiCts;

    // Resume dialog state
    private bool showResumeDialog = false;
    private string resumeGameDetails = "";
    private CustomBingoGameState? pendingGameState;

    protected override async Task OnInitializedAsync()
    {
        // Import device detector module
        module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/deviceDetector.js");
        
        // Detect if device is mobile
        isMobileDevice = await module.InvokeAsync<bool>("DeviceDetector.isMobileDevice");
        
        // Force cards mode on mobile
        if (isMobileDevice)
        {
            selectionMode = SelectionMode.Cards;
        }
        
        // Subscribe to changes
        BingoService.OnSetsChanged += OnBingoSetsChanged;
        
        // Load preferences
        if (!isMobileDevice)
        {
            await LoadModePreferenceAsync();
        }
        
        
        // Load all bingo sets
        await LoadBingoSetsAsync();
          // Check for saved game first
        var savedGame = await GameStateService.LoadCustomGameStateAsync();
        bool hasResumedGame = false;
        
        if (savedGame != null)
        {
            // Show the custom dialog instead of the basic JavaScript confirm
            pendingGameState = savedGame;
            resumeGameDetails = GameStateService.GetCustomGameDetails(savedGame);
            showResumeDialog = true;
            StateHasChanged();
            return; // Wait for user response
        }
        
        // Only check query string if we didn't resume a saved game
        if (!hasResumedGame)
        {
            // Check if there's a set name in the query string
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var query = HttpUtility.ParseQueryString(uri.Query);
            var setName = query["set"];
            if (!string.IsNullOrEmpty(setName))
            {
                selectedSetName = setName;
                pendingSetName = setName;
                await LoadSelectedSetAsync();
            }
        }
    }
    
    private async Task LoadBingoSetsAsync()
    {
        bingoSets = (await BingoService.GetAllAsync()).ToList();
    }
    
    private void OnBingoSetsChanged()
    {
        InvokeAsync(async () => 
        {
            await LoadBingoSetsAsync();
            StateHasChanged();
        });
    }


    private void OnBingoSetSelectionChanged()
    {
        if (pendingSetName != selectedSetName && 
            selectedSet != null && 
            calledItems.Count > 0)
        {
            // Game in progress, confirm the change
            confirmTitle = "Change Bingo Set";
            confirmMessage = $"You're about to switch to a new bingo set. This will reset the current game. Are you sure?";
            showConfirmDialog = true;
            confirmAction = async () =>
            {
                selectedSetName = pendingSetName;
                await LoadSelectedSetAsync();
            };
        }
        else
        {
            // No game in progress or no change, just load
            selectedSetName = pendingSetName;
            _ = LoadSelectedSetAsync();
        }
    }

    private async Task LoadSelectedSetAsync()
    {
        if (!string.IsNullOrEmpty(selectedSetName))
        {
            selectedSet = await BingoService.GetByNameAsync(selectedSetName);
            if (selectedSet != null)
            {
                ResetGame();
            }
        }
        else
        {
            selectedSet = null;
        }
    }
    
    // Keep the synchronous version for backward compatibility
    private void LoadSelectedSet()
    {
        if (!string.IsNullOrEmpty(selectedSetName))
        {
            selectedSet = BingoService.GetByName(selectedSetName);
            if (selectedSet != null)
            {
                ResetGame();
            }
        }
        else
        {
            selectedSet = null;
        }
    }

    private void ResetGame()
    {
        // Cancel any ongoing animations first
        animationCts?.Cancel();
        if (animationCts != null)
        {
            animationCts.Dispose();
            animationCts = null;
        }

        if (selectedSet?.Items?.Length > 0)
        {
            availableItems = new List<string>(selectedSet.Items.Distinct(StringComparer.OrdinalIgnoreCase).ToArray());
            calledItems.Clear();
            currentItem = null;
            displayItem = null;
            isSelecting = false;
            isSelected = false;
            isAnimating = false;            // Assign a new random color theme
            currentThemeColor = BingoApp.Helpers.ColorHelpers.GetRandomDarkColor(random, currentThemeColor);
            
            // Clear any saved game state
            _ = GameStateService.ClearCustomGameStateAsync();
            
            StateHasChanged();
        }
    }

    private void ConfirmNewGame()
    {
        if (calledItems.Count > 0)
        {
            confirmTitle = "Confirm New Game";
            confirmMessage = "Are you sure you want to start a new game? This will reset the current game.";
            showConfirmDialog = true;
            confirmAction = () =>
            {
                NewGame();
                return Task.CompletedTask;
            };
        }
        else
        {
            // No game in progress, just reset
            NewGame();
        }
    }

    private void NewGame()
    {
        ResetGame();
    }

    private void CancelConfirmation()
    {
        showConfirmDialog = false;
        pendingSetName = selectedSetName; // Reset pending selection if canceled
        StateHasChanged();
    }

    private async Task ConfirmAction()
    {
        showConfirmDialog = false;
        if (confirmAction != null)
        {
            await confirmAction.Invoke();
            confirmAction = null;
        }
    }

    private async Task SelectNext()
    {
        if (availableItems.Count == 0 || isSelecting)
        {
            return;
        }

        try
        {
            isSelecting = true;
            isSelected = false;
              // Shuffle the available items before selection
            ListUtils.ShuffleList(availableItems);
            
            StateHasChanged();
            if (selectionMode == SelectionMode.Wheel)
                {
                    await Task.Delay(1000);
                    
                    // Use the BingoWheel component to spin and select an item
                    wheelVisible = true;
                    StateHasChanged();
                      // The wheel component now handles all spinning logic
                    currentItem = wheelRef != null ? await wheelRef.SpinAsync() : null;
                    
                    if (!string.IsNullOrEmpty(currentItem))
                    {
                        // Update game state with the selected item
                        int itemIndex = availableItems.IndexOf(currentItem);
                        if (itemIndex >= 0)
                        {
                            availableItems.RemoveAt(itemIndex);
                            calledItems.Add(currentItem);
                            displayItem = currentItem;
                            
                            // Auto-save game state after item selection
                            await GameStateService.SaveCustomGameStateAsync(calledItems, availableItems, selectedSet?.Name, currentItem);
                        }
                    }
                }
            else if (selectionMode == SelectionMode.Grid)
            {
                await Task.Delay(1000);
                if (gridSelector != null)
                {
                    await gridSelector.StartSelectionAsync();
                }
            }
            else
            {
                // Original card-based selection animation
                displayItem = availableItems[random.Next(availableItems.Count)];
                currentItem = null;
                isAnimating = true;
                StateHasChanged();

                // Cancel any existing animation
                animationCts?.Cancel();
                animationCts = new CancellationTokenSource();
                var token = animationCts.Token;

                // Fast cycling at the beginning
                // Randomize the number of rotations for each phase
                var fastRotations = random.Next(12, 20);
                for (int i = 0; i < fastRotations && !token.IsCancellationRequested; i++)
                {
                    displayItem = availableItems[random.Next(availableItems.Count)];
                    StateHasChanged();
                    await Task.Delay(60, token);
                }

                var mediumRotations = random.Next(8, 14);
                for (int i = 0; i < mediumRotations && !token.IsCancellationRequested; i++)
                {
                    displayItem = availableItems[random.Next(availableItems.Count)];
                    StateHasChanged();
                    await Task.Delay(160, token);
                }

                var slowRotations = random.Next(5, 10);
                for (int i = 0; i < slowRotations && !token.IsCancellationRequested; i++)
                {
                    displayItem = availableItems[random.Next(availableItems.Count)];
                    StateHasChanged();
                    await Task.Delay(250, token);
                }

                if (!token.IsCancellationRequested)
                {
                    // Select the final item
                    int randomIndex = random.Next(0, availableItems.Count);
                    currentItem = availableItems[randomIndex];
                    displayItem = currentItem;
                    availableItems.RemoveAt(randomIndex);
                    calledItems.Add(currentItem);
                    
                    // Auto-save game state after item selection
                    await GameStateService.SaveCustomGameStateAsync(calledItems, availableItems, selectedSet?.Name, currentItem);
                }
            }

            // Show final selection
            isSelecting = false;
            isSelected = true;
            isAnimating = false;
            StateHasChanged();
        }
        catch (OperationCanceledException)
        {
            // Animation was cancelled
        }
        finally
        {
            isSelecting = false;
            if (animationCts != null)
            {
                animationCts.Dispose();
                animationCts = null;
            }
        }
    }

    private async Task ToggleItem(string item)
    {
        if (calledItems.Contains(item))
        {
            calledItems.Remove(item);
            availableItems.Add(item);
        }
        else
        {
            calledItems.Add(item);
            availableItems.Remove(item);
        }
        
        // Auto-save after manual item toggle
        await GameStateService.SaveCustomGameStateAsync(calledItems, availableItems, selectedSet?.Name, currentItem);
        
        StateHasChanged();
    }

    private async Task OnGridItemSelected(string item)
    {
        if (availableItems.Contains(item))
        {
            currentItem = item;
            displayItem = item;
            availableItems.Remove(item);
            calledItems.Add(item);
            isSelecting = false;
            isSelected = true;
            
            // Auto-save game state after grid selection
            await GameStateService.SaveCustomGameStateAsync(calledItems, availableItems, selectedSet?.Name, currentItem);
            
            StateHasChanged();
        }
    }

    private async Task SetMode(SelectionMode mode)
    {
        if (selectionMode != mode && !isMobileDevice)
        {
            selectionMode = mode;
            await SaveModePreferenceAsync();
        }
    }

    private const string ModePreferenceKey = "bingo_selection_mode";
    
    private async Task LoadModePreferenceAsync()
    {
        try
        {
            var savedMode = await LocalStorageService.GetItemAsync<string>(ModePreferenceKey);
            if (!string.IsNullOrEmpty(savedMode) && Enum.TryParse<SelectionMode>(savedMode, out var mode))
            {
                selectionMode = mode;
            }
        }
        catch
        {
            // If loading fails, keep default
            selectionMode = SelectionMode.Cards;
        }
    }
    
    private async Task SaveModePreferenceAsync()
    {
        try
        {
            await LocalStorageService.SetItemAsync(ModePreferenceKey, selectionMode.ToString());
        }
        catch
        {
            // Silently fail if saving doesn't work
        }
    }

    private async Task CelebrateBingo()
    {
        // Cancel any existing confetti animation
        confettiCts?.Cancel();
        confettiCts?.Dispose();
        confettiCts = new CancellationTokenSource();

        try
        {
            showConfetti = true;
            StateHasChanged();

            // Keep confetti showing for 10 seconds
            await Task.Delay(10000, confettiCts.Token);
        }
        catch (OperationCanceledException)
        {
            // Animation was cancelled
        }
        finally
        {
            showConfetti = false;
            StateHasChanged();
        }
    }

    private async Task RestoreGameStateAsync(CustomBingoGameState gameState)
    {
        // Restore basic state
        calledItems = gameState.CalledItems.ToList();
        availableItems = gameState.AvailableItems.ToList();
        selectedSetName = gameState.SelectedSetName ?? "";
        pendingSetName = selectedSetName;
        currentItem = gameState.CurrentItem;
        displayItem = currentItem;
        
        // Load the selected set
        if (!string.IsNullOrEmpty(selectedSetName))
        {
            await LoadSelectedSetAsync();
            
            // Override the reset that LoadSelectedSetAsync does
            calledItems = gameState.CalledItems.ToList();
            availableItems = gameState.AvailableItems.ToList();
            currentItem = gameState.CurrentItem;
            displayItem = currentItem;
            isSelected = currentItem != null;        }
        
        StateHasChanged();
    }

    private async Task OnResumeDialogResult(bool shouldResume)
    {
        showResumeDialog = false;
        StateHasChanged();

        if (shouldResume && pendingGameState != null)
        {
            await RestoreGameStateAsync(pendingGameState);
        }
        else
        {
            // Clear the saved game and continue normal initialization
            await GameStateService.ClearCustomGameStateAsync();
            
            // Continue with normal initialization (query string check)
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var query = HttpUtility.ParseQueryString(uri.Query);
            var setName = query["set"];
            if (!string.IsNullOrEmpty(setName))
            {
                selectedSetName = setName;
                pendingSetName = setName;
                await LoadSelectedSetAsync();
            }
        }
        
        pendingGameState = null;
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        try
        { 
            // Clean up any resources when the component is disposed
            BingoService.OnSetsChanged -= OnBingoSetsChanged;
            animationCts?.Cancel();
            animationCts?.Dispose();
            animationCts = null;            
            confettiCts?.Cancel();
            confettiCts?.Dispose();
            confettiCts = null;

            if (module != null)
            {
                await module.DisposeAsync();
            }
        }        catch
        {
            // Ignore any errors during disposal
        }
    }
    
    private Task OnWheelSelectionComplete(string selectedItem)
    {
        // Handle the selected item from the wheel
        wheelVisible = false;
        isSelecting = false;
        isSelected = true;
        StateHasChanged();
        return Task.CompletedTask;
    }
}
